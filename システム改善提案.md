# NFTè‡ªå‹•Mint ã‚·ã‚¹ãƒ†ãƒ æ”¹å–„ææ¡ˆ

## ç¾åœ¨ã®å•é¡Œ

### ğŸ˜± **Winnerä½“é¨“ã®å•é¡Œ**
- WinnerãŒã€Œè‡ªå‹•ã§mintã•ã‚Œã‚‹ã€ã¨æ€ã„è¾¼ã‚€
- å®Ÿéš›ã«ã¯Approveæ“ä½œãŒå¿…è¦ã ãŒã€ãã‚Œã‚’çŸ¥ã‚‰ãªã„
- 0:00ã«mintå¤±æ•—ã—ã€NFTãŒæ‰‹ã«å…¥ã‚‰ãªã„æ··ä¹±

### ğŸ”§ **æŠ€è¡“çš„ãªå•é¡Œ**
- Approveå¿˜ã‚Œã«ã‚ˆã‚‹è‡ªå‹•mintå¤±æ•—
- ã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªé€šçŸ¥ä¸è¶³
- Winnerå‘ã‘ã®äº‹å‰ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ãªã—

## æ”¹å–„æ¡ˆ

### 1. ğŸ”” **Winneré€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ **

#### ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã®è‡ªå‹•é€šçŸ¥
```javascript
// æ–°æ©Ÿèƒ½: ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«winnerã«é€šçŸ¥
async function notifyWinner(winner, price) {
  // Discord, Email, ã¾ãŸã¯Webhookã§é€šçŸ¥
  await sendNotification(winner.wallet, {
    message: `ğŸ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼${price} POLã§è½æœ­ã•ã‚Œã¾ã—ãŸã€‚
    
    âš ï¸ é‡è¦: NFTã‚’å—ã‘å–ã‚‹ã«ã¯ä»¥ä¸‹ã®æ“ä½œãŒå¿…è¦ã§ã™ï¼š
    1. POLãƒˆãƒ¼ã‚¯ãƒ³ã®Approveå®Ÿè¡Œ (${price} POL)
    2. 0:00ã¾ã§ã«æ“ä½œå®Œäº†
    
    æ“ä½œæ–¹æ³•: https://your-site.com/approve-guide`,
    deadline: '23:59ã¾ã§'
  });
}
```

#### äº‹å‰ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
```javascript
// æ–°API: Winnerå‘ã‘äº‹å‰ãƒã‚§ãƒƒã‚¯
app.get('/api/winner-check/:wallet', async (req, res) => {
  const { wallet } = req.params;
  
  // æœ€æ–°ã®å…¥æœ­æƒ…å ±å–å¾—
  const latestBid = await getLatestBidByWallet(wallet);
  
  if (latestBid && isCurrentWinner(latestBid)) {
    // POLæ®‹é«˜ãƒ»ApproveçŠ¶æ³ãƒã‚§ãƒƒã‚¯
    const paymentStatus = await checkPaymentCapability(wallet, latestBid.price);
    
    res.json({
      isWinner: true,
      price: latestBid.price,
      readyForMint: paymentStatus.canPay,
      nextMintTime: 'Today 0:00',
      actions: paymentStatus.canPay ? [] : [
        { type: 'approve', amount: latestBid.price, required: true }
      ]
    });
  }
});
```

### 2. ğŸ“± **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ”¹å–„**

#### Winnerå‘ã‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
```svelte
<!-- Winner Status Component -->
{#if isCurrentWinner}
  <div class="winner-alert">
    <h2>ğŸ‰ è½æœ­ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</h2>
    <p>ä¾¡æ ¼: {winnerPrice} POL</p>
    
    {#if !readyForMint}
      <div class="action-required">
        <h3>âš ï¸ NFTå—å–ã®ãŸã‚æ“ä½œãŒå¿…è¦ã§ã™</h3>
        <ol>
          <li>
            POLãƒˆãƒ¼ã‚¯ãƒ³ã®Approveå®Ÿè¡Œ ({winnerPrice} POL)
            <button onclick={approvePOL}>ä»Šã™ãApprove</button>
          </li>
          <li>0:00ã¾ã§å¾…æ©Ÿ</li>
        </ol>
        <p>æ®‹ã‚Šæ™‚é–“: {timeUntilMint}</p>
      </div>
    {:else}
      <div class="ready-status">
        <h3>âœ… æº–å‚™å®Œäº†ï¼</h3>
        <p>0:00ã«è‡ªå‹•ã§NFTãŒmintã•ã‚Œã¾ã™</p>
      </div>
    {/if}
  </div>
{/if}
```

### 3. ğŸš¨ **ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½å¼·åŒ–**

#### è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã‚·ã‚¹ãƒ†ãƒ 
```javascript
// æ”¹å–„: mintå¤±æ•—æ™‚ã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
async function createToDayNFT() {
  // ... æ—¢å­˜ã®å‡¦ç† ...
  
  // è‡ªå‹•mintå®Ÿè¡Œï¼ˆæ”¹å–„ç‰ˆï¼‰
  let mintSuccess = false;
  let retryCount = 0;
  const maxRetries = 24; // 24æ™‚é–“ãƒªãƒˆãƒ©ã‚¤
  
  while (!mintSuccess && retryCount < maxRetries) {
    try {
      const mintResult = await executeAutoMint(yesterday);
      
      if (mintResult.ok) {
        console.log(`âœ… [${yesterday}] NFTè‡ªå‹•mintå®Œäº†: ${mintResult.txHash}`);
        mintSuccess = true;
        
        // Winneré€šçŸ¥
        await notifyMintSuccess(winner.wallet, mintResult.txHash);
        
      } else {
        console.warn(`âš ï¸ [${yesterday}] ãƒªãƒˆãƒ©ã‚¤${retryCount + 1}: ${mintResult.message}`);
        
        if (mintResult.message.includes('allowance')) {
          // Approveä¸è¶³ã®å ´åˆã€Winneré€šçŸ¥
          await notifyApprovalRequired(winner.wallet, winner.price);
        }
        
        // 1æ™‚é–“å¾Œã«ãƒªãƒˆãƒ©ã‚¤
        await delay(60 * 60 * 1000);
        retryCount++;
      }
    } catch (error) {
      console.error(`âŒ [${yesterday}] mint ã‚¨ãƒ©ãƒ¼ (${retryCount + 1}å›ç›®):`, error);
      await delay(60 * 60 * 1000);
      retryCount++;
    }
  }
  
  if (!mintSuccess) {
    // 24æ™‚é–“çµŒéã—ã¦ã‚‚mintå¤±æ•—ã®å ´åˆ
    await notifyMintFailed(winner.wallet, yesterday);
    console.error(`âŒ [${yesterday}] 24æ™‚é–“çµŒéã§ã‚‚mintå¤±æ•—ã€‚æ‰‹å‹•å¯¾å¿œãŒå¿…è¦ã€‚`);
  }
}
```

### 4. ğŸ“Š **ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½**

#### ç®¡ç†è€…å‘ã‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
```javascript
// æ–°API: ç®¡ç†è€…å‘ã‘ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³
app.get('/api/admin/mint-status', async (req, res) => {
  const pendingMints = await prisma.PendingMint.findMany({
    where: { minted: false },
    orderBy: { createdAt: 'desc' }
  });
  
  const systemStatus = {
    blockchainConnected: !!nftContract,
    pendingMintsCount: pendingMints.length,
    failedMints: pendingMints.filter(mint => 
      dayjs().diff(dayjs(mint.createdAt), 'hours') > 24
    ),
    recentSuccesses: await getRecentSuccessfulMints()
  };
  
  res.json(systemStatus);
});
```

## å®Ÿè£…å„ªå…ˆåº¦

### ğŸ”¥ **é«˜å„ªå…ˆåº¦** (å³åº§ã«å®Ÿè£…æ¨å¥¨)
1. Winnerå‘ã‘äº‹å‰ãƒã‚§ãƒƒã‚¯API
2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®WinnerçŠ¶æ³è¡¨ç¤º
3. Approveæ“ä½œã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹å¼·åŒ–

### ğŸŸ¡ **ä¸­å„ªå…ˆåº¦** (é€±å†…å®Ÿè£…)
1. è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã‚·ã‚¹ãƒ†ãƒ 
2. Winneré€šçŸ¥æ©Ÿèƒ½
3. ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

### ğŸŸ¢ **ä½å„ªå…ˆåº¦** (æœˆå†…å®Ÿè£…)
1. é«˜åº¦ãªç›£è¦–æ©Ÿèƒ½
2. çµ±è¨ˆãƒ»åˆ†ææ©Ÿèƒ½

## çµè«–

ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€Œè‡ªå‹•mintã€ã¨å‘¼ã‚“ã§ã„ã¾ã™ãŒã€å®Ÿéš›ã«ã¯ **Winnerå´ã®äº‹å‰æº–å‚™ãŒå¿…è¦ãªåŠè‡ªå‹•ã‚·ã‚¹ãƒ†ãƒ ** ã§ã™ã€‚

çœŸã®æ„å‘³ã§ã®ã€Œå®Œå…¨è‡ªå‹•åŒ–ã€ã‚’å®Ÿç¾ã™ã‚‹ã‹ã€ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å‘ä¸Šã•ã›ã¦ã€Œæº–å‚™ãŒå¿…è¦ãªè‡ªå‹•ã‚·ã‚¹ãƒ†ãƒ ã€ã¨ã—ã¦æ˜ç¢ºã«ã™ã‚‹ã‹ã‚’æ±ºã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**æ¨å¥¨**: Winnerå‘ã‘ã®äº‹å‰ãƒã‚§ãƒƒã‚¯ãƒ»é€šçŸ¥æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¢ºå®Ÿã«NFTã‚’å—ã‘å–ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ ã«æ”¹å–„ã™ã‚‹ã€‚